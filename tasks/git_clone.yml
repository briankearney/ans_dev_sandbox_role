---
# Create temporary files and directories
# Reference: https://docs.ansible.com/ansible/latest/collections/ansible/builtin/tempfile_module.html
- name: Set temp directory path from variable
  ansible.builtin.set_fact:
    ans_dev_sandbox_role_temp_dir_path: "{{ temp_dir_path | default(ans_dev_sandbox_role_temp_dir_path) }}"
  changed_when: false

- name: Create Temporary Directory
  ansible.builtin.tempfile:
    state: directory
    suffix: _ansible_sandbox
  register: ans_dev_sandbox_role_temp_dir_results
  when: ans_dev_sandbox_role_temp_dir_path == ""
  changed_when: true

- name: Use Fixed Temporary Directory Path
  ansible.builtin.set_fact:
    ans_dev_sandbox_role_temp_dir_results:
      path: "{{ ans_dev_sandbox_role_temp_dir_path }}"
  when: ans_dev_sandbox_role_temp_dir_path != ""
  changed_when: false

- name: Ensure Fixed Temporary Directory Exists
  ansible.builtin.file:
    path: "{{ ans_dev_sandbox_role_temp_dir_path }}"
    state: directory
    mode: '0755'
  when: ans_dev_sandbox_role_temp_dir_path != ""
  register: ans_dev_sandbox_role_fixed_dir_results

# Clone git repository using HTTPS
# Reference: https://docs.ansible.com/ansible/latest/collections/ansible/builtin/git_module.html
- name: Clone GitHub Repository
  ansible.builtin.git:
    repo: "{{ ans_dev_sandbox_role_git_repo_url }}"
    dest: "{{ ans_dev_sandbox_role_temp_dir_results.path }}/"
    version: "{{ ans_dev_sandbox_role_git_repo_version }}"
    update: true
    force: false
  environment:
    GIT_TERMINAL_PROMPT: "false"
    GIT_ASKPASS: /bin/true
  register: ans_dev_sandbox_role_git_clone_results
  failed_when: ans_dev_sandbox_role_git_clone_results.failed

# Recursively find all files in the cloned directory
# Reference: https://docs.ansible.com/ansible/latest/collections/ansible/builtin/find_module.html
- name: List Cloned Files
  ansible.builtin.find:
    paths: "{{ ans_dev_sandbox_role_temp_dir_results.path }}"
    recurse: true
  register: ans_dev_sandbox_role_find_results
  when: not ans_dev_sandbox_role_git_clone_results.failed

# Display the fully qualified file names in the cloned directory
# Reference: https://docs.ansible.com/ansible/latest/collections/ansible/builtin/debug_module.html
- name: Display Files Found in Repository
  ansible.builtin.debug:
    msg: |
      Repository cloned successfully to: {{ ans_dev_sandbox_role_temp_dir_results.path }}
      Total files found: {{ ans_dev_sandbox_role_find_results.files | length }}
      File list:
      {{ ans_dev_sandbox_role_find_results.files | map(attribute='path') | list | to_nice_yaml }}
  when: ans_dev_sandbox_role_find_results.files is defined and ans_dev_sandbox_role_find_results.files | length > 0

- name: Display Empty Repository Message
  ansible.builtin.debug:
    msg: "Repository was cloned but no files were found in {{ ans_dev_sandbox_role_temp_dir_results.path }}"
  when: ans_dev_sandbox_role_find_results.files is not defined or ans_dev_sandbox_role_find_results.files | length == 0
